version: 2.1

jobs:
  build-and-test:
    machine: true
    steps:
      - checkout

      - run:
          name: Install PDM
          command: |
            curl -sSL https://raw.githubusercontent.com/pdm-project/pdm/main/install-pdm.py | python3 -
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Debugging PATH and PDM installation
          command: |
            echo "Current PATH: $PATH"
            which pdm || echo "pdm not found in PATH"
            pdm --version || echo "pdm command not executable"

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pdm.lock" }}

      - run:
          name: Install Dependencies
          command: |
            source $BASH_ENV
            pdm install

      - save_cache:
          paths:
            - ~/.pdm
          key: v1-dependencies-{{ checksum "pdm.lock" }}

      - run:
          name: Check Code Formatting with Black
          command: |
            source $BASH_ENV
            pdm run black --check src/ tests/

      - run:
          name: Static Analysis with Mypy
          command: |
            source $BASH_ENV
            pdm run mypy src/

      - run:
          name: Linting with Ruff
          command: |
            source $BASH_ENV
            pdm run ruff src/ tests/


      # Code formatting check with black
      - run:
          name: Check Code Formatting with Black
          command: pdm run black --check src/ tests/

      # Run unit tests with pytest
      - run:
          name: Run Unit Tests with Pytest
          command: |
            source $BASH_ENV
            pdm run pytest

workflows:
  version: 2
  build-and-test-workflow:
    jobs:
      - build-and-test
